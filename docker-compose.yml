version: '3.8'

services:
  rag-app:
    build: .
    ports:
      - "8000:8000"
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
      - ./chroma_db:/app/chroma_db
    environment:
      - NVIDIA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # Â¡No pongas CUDA_VISIBLE_DEVICES=""!
    gpus: "all"        # <- ESTA es la clave con Compose
    profiles:
      - gpu

  rag-app-cpu:
    build: .
    ports:
      - "8000:8000"
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
      - ./chroma_db:/app/chroma_db
    environment:
      - NVIDIA_VISIBLE_DEVICES=
      - CUDA_VISIBLE_DEVICES=
    profiles:
      - cpu

volumes:
  ollama_models:
    external: false